import { Meta } from '@storybook/blocks';

<Meta title="Helpers" />

### Helpers & Utiltiy Functions

This guide provides a comprehensive overview of all utility functions available in the DeSo UI library. These functions help you work with DeSo-specific data, formatting, and common UI patterns.

You can find this file in the [src/lib/utils/deso.tsx](https://github.com/deso-protocol/deso-ui/blob/main/src/lib/utils/deso.tsx) file.

### Table of Contents

- [Styling Utilities](#styling-utilities)
- [Profile & User Functions](#profile--user-functions)
- [Formatting Functions](#formatting-functions)
- [Text Processing](#text-processing)
- [Validation Functions](#validation-functions)
- [Clipboard Utilities](#clipboard-utilities)
- [React Components](#react-components)

---

### Styling Utilities

#### `cn(...inputs: ClassValue[])`

Combines and merges Tailwind CSS classes intelligently, handling conflicts and duplicates.

```tsx
import { cn } from '@/lib/utils/deso';

// Basic usage
const className = cn('px-4 py-2', 'bg-blue-500', 'text-white');

// Conditional classes
const buttonClass = cn(
  'px-4 py-2 rounded',
  isActive && 'bg-blue-500 text-white',
  isDisabled && 'opacity-50 cursor-not-allowed'
);

// Merging conflicting classes (twMerge handles conflicts)
const merged = cn('px-2 px-4', 'py-1 py-3'); // Results in 'px-4 py-3'
```

**Parameters:**
- `inputs` - Any number of class values (strings, objects, arrays)

**Returns:** Merged class string

---

### Profile & User Functions

#### `buildProfilePictureUrl(profilePic?, extraData?, variant?)`

Builds the appropriate profile picture URL from DeSo profile data, handling different formats and variants.

```tsx
import { buildProfilePictureUrl } from '@/lib/utils/deso';

// Basic usage
const avatarUrl = buildProfilePictureUrl(
  profile.profilePic,
  profile.extraData
);

// High-resolution variant
const highResUrl = buildProfilePictureUrl(
  profile.profilePic,
  profile.extraData,
  'highres'
);

// NFT profile picture
const nftUrl = buildProfilePictureUrl(
  profile.profilePic,
  profile.extraData,
  'nft'
);
```

**Parameters:**
- `profilePic` (optional) - Profile picture data (URL or hex-encoded)
- `extraData` (optional) - Additional profile data object
- `variant` - `'default' | 'nft' | 'highres'` (default: 'default')

**Returns:** Profile picture URL string or undefined

**Variants:**
- `default` - Standard profile picture with fallback logic
- `highres` - High-resolution version if available
- `nft` - NFT profile picture if set

---

#### `getDisplayName(username?, extraData?)`

Gets the display name for a user, with fallback to username or "Anonymous".

```tsx
import { getDisplayName } from '@/lib/utils/deso';

const displayName = getDisplayName(
  profile.username,
  profile.extraData
);
// Returns: "John Doe" or "johndoe" or "Anonymous"
```

**Parameters:**
- `username` (optional) - User's username
- `extraData` (optional) - Profile extra data containing DisplayName

**Returns:** Display name string

---

#### `getUsernameInitial(username?)`

Gets the first letter of a username for avatar placeholders.

```tsx
import { getUsernameInitial } from '@/lib/utils/deso';

const initial = getUsernameInitial('johndoe'); // Returns: "J"
const fallback = getUsernameInitial(); // Returns: "?"
```

**Parameters:**
- `username` (optional) - User's username

**Returns:** Single character string

---

#### `getSingleProfilePictureUrl(publicKey, fallbackUrl?)`

Returns the official DeSo endpoint URL for fetching profile pictures.

```tsx
import { getSingleProfilePictureUrl } from '@/lib/utils/deso';

const profilePicUrl = getSingleProfilePictureUrl(
  'BC1YL...',
  'https://example.com/default-avatar.png'
);
// Returns: 'https://node.deso.org/api/v0/get-single-profile-picture/BC1YL...?fallback=...'
```

**Parameters:**
- `publicKey` - User's public key (Base58Check format)
- `fallbackUrl` (optional) - Default image URL if no profile picture exists

**Returns:** Complete URL string

---

### Formatting Functions

#### `formatDesoAmount(nanos)`

Formats DeSo amounts from nanos to human-readable format.

```tsx
import { formatDesoAmount } from '@/lib/utils/deso';

formatDesoAmount(1000000000); // "1.00 DESO"
formatDesoAmount(500000);     // "< 0.001 DESO"
formatDesoAmount(5000000000000); // "5.0K DESO"
```

**Parameters:**
- `nanos` - Amount in nanos (1 DESO = 1e9 nanos)

**Returns:** Formatted string with DESO suffix

---

#### `formatCount(count, abbreviated?, decimals?)`

Formats large numbers with K/M abbreviations or full locale formatting.

```tsx
import { formatCount } from '@/lib/utils/deso';

// Abbreviated format (default)
formatCount(1234);     // "1.23K"
formatCount(1234567);  // "1.23M"
formatCount(999);      // "999"

// Full format
formatCount(1234, false); // "1,234"

// Custom decimals
formatCount(1234, true, 1); // "1.2K"
```

**Parameters:**
- `count` - Number to format
- `abbreviated` (optional) - Use K/M abbreviations (default: true)
- `decimals` (optional) - Decimal places for abbreviated format (default: 2)

**Returns:** Formatted number string

---

#### `formatTimestamp(timestamp)`

Formats timestamps into relative time, full date, and full datetime formats.

```tsx
import { formatTimestamp } from '@/lib/utils/deso';

const formatted = formatTimestamp(new Date());
// Returns: {
//   relative: "2m ago",
//   fullDate: "12/25/2023",
//   fullDateTime: "December 25, 2023 at 3:45 PM"
// }

// Usage in components
const { relative, fullDateTime } = formatTimestamp(post.timestamp);
```

**Parameters:**
- `timestamp` - Date string or Date object

**Returns:** Object with three formatted strings:
- `relative` - Relative time (e.g., "2m ago", "Just now")
- `fullDate` - Short date format
- `fullDateTime` - Full date and time format

---

### Text Processing

---

#### `truncateText(text, maxLength)`

Truncates text to a specified length with ellipsis.

```tsx
import { truncateText } from '@/lib/utils/deso';

const short = truncateText("This is a very long text", 10);
// Returns: "This is a..."
```

**Parameters:**
- `text` - Text to truncate
- `maxLength` - Maximum character length

**Returns:** Truncated string with ellipsis if needed

---

#### `truncateMiddle(str, startChars?, endChars?)`

Truncates text in the middle, keeping start and end portions (useful for public keys).

```tsx
import { truncateMiddle } from '@/lib/utils/deso';

const publicKey = "BC1YLhtBTFXAsKZgoaoYNW8mWAJWdfQjycheAeYjaX46azVrnZfJ94s";
const shortened = truncateMiddle(publicKey, 6, 6);
// Returns: "BC1YLh...nZfJ94s"

// Custom lengths
const custom = truncateMiddle(publicKey, 10, 4);
// Returns: "BC1YLhtBTF...J94s"
```

**Parameters:**
- `str` - String to truncate
- `startChars` (optional) - Characters to keep at start (default: 6)
- `endChars` (optional) - Characters to keep at end (default: 6)

**Returns:** Truncated string with ellipsis in middle

---

#### `extractHashtags(text)`

Extracts all hashtags from text.

```tsx
import { extractHashtags } from '@/lib/utils/deso';

const hashtags = extractHashtags("Love #DeSo and #crypto! #web3");
// Returns: ["#DeSo", "#crypto", "#web3"]
```

**Parameters:**
- `text` - Text to search for hashtags

**Returns:** Array of hashtag strings (including #)

---

#### `extractMentions(text)`

Extracts all mentions from text.

```tsx
import { extractMentions } from '@/lib/utils/deso';

const mentions = extractMentions("Hey @alice and @bob, check this out!");
// Returns: ["@alice", "@bob"]
```

**Parameters:**
- `text` - Text to search for mentions

**Returns:** Array of mention strings (including @)

---

#### `processPostContent(body)`

Processes post content and extracts hashtags and mentions.

```tsx
import { processPostContent } from '@/lib/utils/deso';

const processed = processPostContent("Love #DeSo! Thanks @alice");
// Returns: {
//   text: "Love #DeSo! Thanks @alice",
//   hashtags: ["#DeSo"],
//   mentions: ["@alice"]
// }
```

**Parameters:**
- `body` - Post content text

**Returns:** Object with text, hashtags, and mentions arrays

---

#### `pluralize(count, singular, plural?)`

Simple pluralization helper for displaying counts.

```tsx
import { pluralize } from '@/lib/utils/deso';

pluralize(1, 'like');     // "like"
pluralize(5, 'like');     // "likes"
pluralize(1, 'reply', 'replies'); // "reply"
pluralize(3, 'reply', 'replies'); // "replies"

// Usage in components
const likeText = `${count} ${pluralize(count, 'like')}`;
```

**Parameters:**
- `count` - Number to check
- `singular` - Singular form of the word
- `plural` (optional) - Plural form (defaults to singular + 's')

**Returns:** Appropriate singular or plural form

---

### Validation Functions

#### `isValidPublicKey(publicKey)`

Validates DeSo public key format.

```tsx
import { isValidPublicKey } from '@/lib/utils/deso';

isValidPublicKey('BC1YLhtBTFXAsKZgoaoYNW8mWAJWdfQjycheAeYjaX46azVrnZfJ94s'); // true
isValidPublicKey('invalid-key'); // false
```

**Parameters:**
- `publicKey` - Public key string to validate

**Returns:** Boolean indicating if key is valid

---

### Clipboard Utilities

#### `copyToClipboard(text)`

Copies text to clipboard with fallback for older browsers.

```tsx
import { copyToClipboard } from '@/lib/utils/deso';

const handleCopy = async () => {
  const success = await copyToClipboard('Text to copy');
  if (success) {
    console.log('Copied successfully!');
  } else {
    console.log('Copy failed');
  }
};
```

**Parameters:**
- `text` - Text to copy to clipboard

**Returns:** Promise&lt;boolean&gt; indicating success

---

### React Components

#### `ParsedText`

React component that parses text and makes hashtags, mentions, and links clickable.

```tsx
import { ParsedText } from '@/lib/utils/deso';

// Basic usage
<ParsedText text="Check out #DeSo and follow @alice! Visit https://deso.org" />

// Renders clickable links for:
// - Hashtags → /search?q=DeSo
// - Mentions → /alice  
// - URLs → https://deso.org (opens in new tab)
```

**Props:**
- `text` - Text content to parse and render

**Features:**
- Automatically detects and links hashtags, mentions, and URLs
- Hashtags link to search pages
- Mentions link to user profiles
- URLs open in new tabs with security attributes
- Truncates long URLs for better display

---

### Usage Examples

#### Complete Profile Display

```tsx
import {
  buildProfilePictureUrl,
  getDisplayName,
  getUsernameInitial,
  truncateMiddle,
  formatCount
} from '@/lib/utils/deso';

function ProfileCard({ profile }) {
  const avatarUrl = buildProfilePictureUrl(
    profile.profilePic,
    profile.extraData
  );
  const displayName = getDisplayName(profile.username, profile.extraData);
  const initial = getUsernameInitial(profile.username);
  const shortKey = truncateMiddle(profile.publicKey);
  const followerCount = formatCount(profile.followerCount);

  return (
    <div className="profile-card">
      {avatarUrl ? (
        <img src={avatarUrl} alt={displayName} />
      ) : (
        <div className="avatar-fallback">{initial}</div>
      )}
      <h3>{displayName}</h3>
      <p>@{profile.username}</p>
      <p>{shortKey}</p>
      <p>{followerCount} followers</p>
    </div>
  );
}
```

---

#### Post Content Processing

```tsx
import {
  ParsedText,
  formatTimestamp,
  formatCount,
  pluralize
} from '@/lib/utils/deso';

function PostCard({ post }) {
  const { relative } = formatTimestamp(post.timestamp);
  const likeCount = formatCount(post.likeCount);
  const likeText = pluralize(post.likeCount, 'like');

  return (
    <div className="post-card">
      <ParsedText text={post.content} />
      <div className="post-meta">
        <span>{relative}</span>
        <span>{likeCount} {likeText}</span>
      </div>
    </div>
  );
}
```

---

#### Copy-to-Clipboard Button

```tsx
import { copyToClipboard, truncateMiddle } from '@/lib/utils/deso';
import { useState } from 'react';

function CopyablePublicKey({ publicKey }) {
  const [copied, setCopied] = useState(false);
  
  const handleCopy = async () => {
    const success = await copyToClipboard(publicKey);
    if (success) {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  return (
    <button onClick={handleCopy} className="copy-button">
      {truncateMiddle(publicKey)}
      {copied ? ' ✓' : ' 📋'}
    </button>
  );
}
```

---

### Best Practices

1. **Profile Pictures**: Always use `buildProfilePictureUrl()` with fallbacks for consistent avatar display
2. **Text Truncation**: Use `truncateMiddle()` for public keys and `truncateText()` for general content
3. **Number Formatting**: Use `formatCount()` for all user-facing numbers (likes, followers, etc.)
4. **Timestamps**: Use `formatTimestamp()` to provide both relative and absolute time information
5. **Content Parsing**: Use `ParsedText` component for any user-generated content that might contain links
6. **Validation**: Always validate public keys with `isValidPublicKey()` before using them
7. **Accessibility**: Combine formatting functions with proper ARIA labels for screen readers

This comprehensive set of utilities provides everything you need to build DeSo applications with consistent formatting, proper data handling, and excellent user experience.
